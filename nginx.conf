# HTTP server - handles ACME challenge and proxies app (no HTTPS redirect in dev)
server {
  listen 80;
  server_name easyshop.shaheen.homes localhost;

  # ACME challenge location (must be exact path)
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  # Proxy Next.js app directly (disable redirect during local/dev)
  location / {
    proxy_pass         http://easyshop-frontend:3000;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    # WebSocket support for Next.js
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection "upgrade";

    # Timeouts
    proxy_read_timeout  90s;
    proxy_send_timeout  90s;
  }

  # Cache static assets aggressively (adjust as needed)
  location ~* ^/_next/static/ {
    proxy_pass http://easyshop-frontend:3000;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  location ~* ^/static/ {
    proxy_pass http://easyshop-frontend:3000;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }
}

# HTTPS server (disabled for now until certificates exist)
# server {
#   listen 443 ssl http2;
#   server_name easyshop.shaheen.homes;
#
#   client_max_body_size 25m;
#   ssl_certificate     /etc/letsencrypt/live/easyshop.shaheen.homes/fullchain.pem;
#   ssl_certificate_key /etc/letsencrypt/live/easyshop.shaheen.homes/privkey.pem;
#   ssl_protocols TLSv1.2 TLSv1.3;
#   ssl_prefer_server_ciphers on;
#
#   location / {
#     proxy_pass         http://easyshop-frontend:3000;
#     proxy_http_version 1.1;
#     proxy_set_header   Host              $host;
#     proxy_set_header   X-Real-IP         $remote_addr;
#     proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
#     proxy_set_header   X-Forwarded-Proto $scheme;
#     proxy_set_header   Upgrade $http_upgrade;
#     proxy_set_header   Connection "upgrade";
#     proxy_read_timeout  90s;
#     proxy_send_timeout  90s;
#   }
#
#   location ~* ^/_next/static/ {
#     proxy_pass http://easyshop-frontend:3000;
#     add_header Cache-Control "public, max-age=31536000, immutable";
#   }
#
#   location ~* ^/static/ {
#     proxy_pass http://easyshop-frontend:3000;
#     add_header Cache-Control "public, max-age=31536000, immutable";
#   }
# }
